#!/usr/bin/env python
import os
import json
import argparse
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt


def ensure_dir(path: str):
    os.makedirs(path, exist_ok=True)


def max_drawdown(equity: np.ndarray) -> float:
    """
    Max drawdown in fraction (0.15 -> 15%).
    """
    if len(equity) == 0:
        return 0.0
    peaks = np.maximum.accumulate(equity)
    dd = (equity - peaks) / np.maximum(peaks, 1e-9)
    return float(dd.min())


def profit_factor_from_series(pnl: pd.Series) -> float:
    gains = pnl[pnl > 0].sum()
    losses = -pnl[pnl < 0].sum()
    if losses <= 0:
        return float("inf") if gains > 0 else 0.0
    return float(gains / losses)


def sharpe_ratio(pnl: pd.Series, risk_free: float = 0.0) -> float:
    """
    Simple per-trade Sharpe: (mean(excess) / std) * sqrt(N)
    """
    if len(pnl) < 2:
        return 0.0
    excess = pnl - risk_free
    mu = excess.mean()
    sigma = excess.std(ddof=1)
    if sigma <= 0:
        return 0.0
    return float(mu / sigma * np.sqrt(len(pnl)))


def parse_args():
    ap = argparse.ArgumentParser()
    ap.add_argument("--csv", type=str, default="eval/eval_trades.csv",
                    help="Path to eval_trades.csv generated by eval_dqn.py")
    ap.add_argument("--outdir", type=str, default="eval_analysis",
                    help="Output directory for reports & plots")
    ap.add_argument("--initial-balance", type=float, default=100000.0,
                    help="Starting balance used for equity curve")
    ap.add_argument("--rolling-window", type=int, default=32,
                    help="Window (trades) for rolling win rate")
    return ap.parse_args()


def main():
    args = parse_args()
    ensure_dir(args.outdir)

    if not os.path.exists(args.csv):
        raise FileNotFoundError(f"CSV not found: {args.csv}")

    df = pd.read_csv(args.csv)

    if "profit_net_usd" not in df.columns:
        raise ValueError("CSV missing 'profit_net_usd' column. "
                         "Check eval_dqn.py version.")

    # --- Basic setup ---
    pnl = df["profit_net_usd"].astype(float)
    equity = pnl.cumsum() + float(args.initial_balance)

    # --- Core metrics ---
    n_trades = len(df)
    wins = int((pnl >= 0).sum())
    losses = int((pnl < 0).sum())
    win_rate = float(wins / n_trades) if n_trades > 0 else 0.0

    pf_net = profit_factor_from_series(pnl)
    expectancy = float(pnl.mean()) if n_trades > 0 else 0.0

    avg_win = float(pnl[pnl > 0].mean()) if (pnl > 0).any() else 0.0
    avg_loss = float(-pnl[pnl < 0].mean()) if (pnl < 0).any() else 0.0
    rr_ratio = float(avg_win / avg_loss) if avg_loss > 0 else float("inf")

    mdd_abs = max_drawdown(equity)
    mdd_pct = float(mdd_abs)

    sharpe = sharpe_ratio(pnl)

    # Pips / R if available
    avg_pips = float(df["pnl_pips"].mean()) if "pnl_pips" in df.columns else None
    avg_R = None
    if "profit_net_R" in df.columns:
        avg_R = float(df["profit_net_R"].mean())
    elif "profit_R_net" in df.columns:
        avg_R = float(df["profit_R_net"].mean())

    # Costs
    commission_total = float(df["commission_usd"].sum()) if "commission_usd" in df.columns else 0.0
    swap_total = float(df["swap_usd"].sum()) if "swap_usd" in df.columns else 0.0
    other_total = float(df["other_cost_usd"].sum()) if "other_cost_usd" in df.columns else 0.0
    gross_before_costs = float(df.get("profit_gross_usd", pnl).sum())
    net_after_costs = float(pnl.sum())
    cost_total = commission_total + swap_total + other_total
    cost_as_pct_gross = float(cost_total / gross_before_costs) if gross_before_costs != 0 else 0.0

    # Rolling metrics
    window = max(1, int(args.rolling_window))
    rolling_win = (pnl >= 0).rolling(window).mean() * 100.0
    rolling_equity = equity

    # --- Build summary dict ---
    summary = {
        "trades": n_trades,
        "wins": wins,
        "losses": losses,
        "win_rate": win_rate,
        "profit_factor_net": pf_net,
        "expectancy_net_usd": expectancy,
        "avg_win_usd": avg_win,
        "avg_loss_usd": avg_loss,
        "reward_risk_ratio": rr_ratio,
        "net_profit_usd": net_after_costs,
        "gross_profit_usd": gross_before_costs,
        "total_commission_usd": commission_total,
        "total_swap_usd": swap_total,
        "total_other_costs_usd": other_total,
        "total_costs_usd": cost_total,
        "costs_as_pct_gross": cost_as_pct_gross,
        "max_drawdown_fraction": mdd_pct,
        "max_drawdown_percent": mdd_pct * 100.0,
        "sharpe_per_trade": sharpe,
        "initial_balance": float(args.initial_balance),
        "final_equity": float(equity.iloc[-1]) if len(equity) > 0 else float(args.initial_balance),
        "avg_pnl_pips": avg_pips,
        "avg_pnl_R": avg_R,
        "rolling_window_trades": window,
    }

    # --- Save JSON summary ---
    json_path = os.path.join(args.outdir, "summary.json")
    with open(json_path, "w") as f:
        json.dump(summary, f, indent=2)

    # --- Save text summary (human-readable) ---
    txt_path = os.path.join(args.outdir, "summary.txt")
    with open(txt_path, "w") as f:
        f.write("EVAL TRADES ANALYSIS\n")
        f.write("====================\n\n")
        f.write(f"Trades:             {n_trades}\n")
        f.write(f"Wins:               {wins}\n")
        f.write(f"Losses:             {losses}\n")
        f.write(f"Win rate:           {win_rate*100:.2f}%\n")
        f.write(f"Profit factor (net):{pf_net:.3f}\n")
        f.write(f"Expectancy (net):   {expectancy:.4f} USD / trade\n")
        f.write(f"Avg win:            {avg_win:.4f} USD\n")
        f.write(f"Avg loss:           {avg_loss:.4f} USD\n")
        f.write(f"Reward:Risk ratio:  {rr_ratio:.3f}\n")
        f.write(f"Net profit:         {net_after_costs:.2f} USD\n")
        f.write(f"Gross profit:       {gross_before_costs:.2f} USD\n")
        f.write(f"Total commission:   {commission_total:.2f} USD\n")
        f.write(f"Total swap:         {swap_total:.2f} USD\n")
        f.write(f"Total other costs:  {other_total:.2f} USD\n")
        f.write(f"Costs vs gross:     {cost_as_pct_gross*100:.2f}%\n")
        f.write(f"Max drawdown:       {mdd_pct*100:.2f}%\n")
        f.write(f"Sharpe (per trade): {sharpe:.3f}\n")
        f.write(f"Initial balance:    {args.initial_balance:.2f} USD\n")
        if len(equity) > 0:
            f.write(f"Final equity:       {equity.iloc[-1]:.2f} USD\n")
        if avg_pips is not None:
            f.write(f"Avg PnL:            {avg_pips:.4f} pips\n")
        if avg_R is not None:
            f.write(f"Avg PnL:            {avg_R:.4f} R\n")

    # --- Plots ---

    # 1) Equity curve
    if len(equity) > 0:
        plt.figure()
        plt.plot(equity)
        plt.title("Equity Curve (Net PnL)")
        plt.xlabel("Trade #")
        plt.ylabel("Equity (USD)")
        plt.grid(True)
        plt.tight_layout()
        plt.savefig(os.path.join(args.outdir, "equity_curve.png"))
        plt.close()

    # 2) Net PnL histogram
    if n_trades > 0:
        plt.figure()
        plt.hist(pnl, bins=50)
        plt.title("Distribution of Net Trade PnL (USD)")
        plt.xlabel("Net PnL (USD)")
        plt.ylabel("Frequency")
        plt.tight_layout()
        plt.savefig(os.path.join(args.outdir, "pnl_hist.png"))
        plt.close()

    # 3) Rolling win rate + equity (two y-axes)
    if n_trades > 0:
        plt.figure()
        ax1 = plt.gca()
        ax1.plot(rolling_win, label=f"Rolling Win Rate ({window} trades)")
        ax1.set_xlabel("Trade #")
        ax1.set_ylabel("Win Rate (%)")
        ax2 = ax1.twinx()
        ax2.plot(rolling_equity, linestyle="--", label="Equity")
        ax2.set_ylabel("Equity (USD)")

        # Simple legend merge
        lines, labels = ax1.get_legend_handles_labels()
        lines2, labels2 = ax2.get_legend_handles_labels()
        ax1.legend(lines + lines2, labels + labels2, loc="best")

        plt.title("Rolling Win Rate & Equity")
        plt.tight_layout()
        plt.savefig(os.path.join(args.outdir, "rolling_winrate_equity.png"))
        plt.close()

    # 4) Cost breakdown bar plot (if costs exist)
    if cost_total != 0.0:
        labels = []
        values = []
        if commission_total != 0.0:
            labels.append("Commission")
            values.append(commission_total)
        if swap_total != 0.0:
            labels.append("Swap")
            values.append(swap_total)
        if other_total != 0.0:
            labels.append("Other")
            values.append(other_total)

        if labels:
            plt.figure()
            plt.bar(labels, values)
            plt.title("Total Trading Costs Breakdown (USD)")
            plt.ylabel("USD")
            plt.tight_layout()
            plt.savefig(os.path.join(args.outdir, "cost_breakdown.png"))
            plt.close()

    print(f"Analysis complete. Outputs saved to: {args.outdir}")
    print(f"- {json_path}")
    print(f"- {txt_path}")
    print("- equity_curve.png, pnl_hist.png, rolling_winrate_equity.png, cost_breakdown.png (if applicable)")


if __name__ == "__main__":
    main()
